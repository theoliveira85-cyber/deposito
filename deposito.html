<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Estoque">
    <meta name="msapplication-TileColor" content="#2c3e50">
    <meta name="msapplication-config" content="browserconfig.xml">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232c3e50' width='192' height='192'/><text x='96' y='120' font-size='80' font-weight='bold' fill='%23ffffff' text-anchor='middle'>üì¶</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232c3e50' width='192' height='192' rx='45'/><text x='96' y='120' font-size='80' font-weight='bold' fill='%23ffffff' text-anchor='middle'>üì¶</text></svg>">
    <title>Dashboard - Estoque Deposito [v2.0]</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #2c3e50;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        h1 {
            font-size: 28px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
        }
        
        .stat-card h3 {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 30px;
        }
        
        .dashboard-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin-bottom: 30px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .period-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .period-tab {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .period-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .period-tab.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 16px rgba(245, 87, 108, 0.4);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        input, button {
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input {
            background: white;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        select {
            padding: 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #ecf0f1;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #bdc3c7;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        .low-stock {
            background: #fadbd8;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            background: #3498db;
            margin-right: 5px;
        }
        
        .btn-small:hover {
            background: #2980b9;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn-export {
            padding: 10px 20px;
            background: #16a085;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-export:hover {
            background: #138d75;
        }
        
        .btn-export.pdf {
            background: #e74c3c;
        }
        
        .btn-export.pdf:hover {
            background: #c0392b;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filters select {
            padding: 10px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .category-group {
            margin-bottom: 25px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        
        .category-title {
            background: #ecf0f1;
            padding: 10px 15px;
            margin: -15px -15px 15px -15px;
            font-weight: bold;
            color: #2c3e50;
            border-radius: 4px 0 0 0;
        }
        
        .volume-subgroup {
            margin-bottom: 15px;
        }
        
        .volume-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
            font-weight: 600;
            padding: 5px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 18px;
                text-align: center;
            }
            
            .stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card h3 {
                font-size: 12px;
            }
            
            .stat-card .number {
                font-size: 28px;
            }
            
            .controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .controls input,
            .controls button {
                width: 100%;
                padding: 14px;
                font-size: 16px;
            }
            
            .filters {
                flex-direction: column;
                gap: 10px;
            }
            
            .filters select {
                width: 100%;
                padding: 14px;
                font-size: 16px;
            }
            
            .export-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .export-buttons button {
                width: 100%;
                padding: 14px;
                font-size: 16px;
            }
            
            /* Esconder tabela e mostrar cards no mobile */
            table {
                display: none;
            }
            
            .mobile-card {
                display: block !important;
                background: white;
                padding: 16px;
                margin-bottom: 12px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .mobile-card-header {
                font-weight: bold;
                font-size: 16px;
                color: #2c3e50;
                margin-bottom: 12px;
                padding-bottom: 10px;
                border-bottom: 2px solid #ecf0f1;
            }
            
            .mobile-card-row {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                font-size: 14px;
            }
            
            .mobile-card-label {
                color: #7f8c8d;
                font-weight: 600;
            }
            
            .mobile-card-value {
                color: #2c3e50;
                font-weight: bold;
            }
            
            .mobile-card-actions {
                display: flex;
                gap: 8px;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid #ecf0f1;
            }
            
            .mobile-card-actions button {
                flex: 1;
                padding: 12px;
                font-size: 14px;
                font-weight: 600;
            }
            
            .period-tabs {
                gap: 8px;
            }
            
            .period-tab {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .dashboard-section {
                padding: 20px;
            }
            
            .table-container {
                padding: 20px;
            }
        }
        
        /* Cards mobile - escondidos por padr√£o */
        .mobile-card {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì¶ Galpao Seu Vital - Controle de Estoque</h1>
        </header>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Total de Produtos</h3>
                <div class="number" id="totalProdutos">0</div>
            </div>
            <div class="stat-card">
                <h3>Valor Total em Estoque</h3>
                <div class="number" id="valorTotal">R$ 0</div>
            </div>
            <div class="stat-card">
                <h3>Produtos com Baixo Estoque</h3>
                <div class="number" id="baixoEstoque">0</div>
            </div>
        </div>
        
        <!-- Dashboard de Gr√°ficos -->
        <div class="dashboard-section">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">üìä An√°lise de Movimenta√ß√£o</h2>
            <div class="period-tabs">
                <button class="period-tab active" onclick="atualizarGrafico(7)">7 Dias</button>
                <button class="period-tab" onclick="atualizarGrafico(15)">15 Dias</button>
                <button class="period-tab" onclick="atualizarGrafico(21)">21 Dias</button>
                <button class="period-tab" onclick="atualizarGrafico(30)">30 Dias</button>
            </div>
            <div class="chart-container">
                <canvas id="movimentacaoChart"></canvas>
            </div>
        </div>
        
        <div class="table-container">
            <div class="controls">
                <input type="text" id="searchInput" placeholder="Buscar produto...">
                <button onclick="adicionarProduto()">+ Adicionar Produto</button>
            </div>
            
            <div class="filters">
                <label style="font-weight: 600; color: #2c3e50;">Filtrar por:</label>
                <select id="filterCategoria" onchange="renderizarTabela()">
                    <option value="">Todas as Categorias</option>
                </select>
                <select id="filterVolume" onchange="renderizarTabela()">
                    <option value="">Todos os Volumes</option>
                    <option value="2L">2L</option>
                    <option value="5L">5L</option>
                </select>
            </div>
            
            <div class="export-buttons">
                <button class="btn-export" onclick="exportarExcel()">üìä Exportar (CSV)</button>
                <button class="btn-export pdf" onclick="exportarPDF()">üìÑ Exportar para PDF</button>
                <button class="btn-export" onclick="converterDadosAntigos()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">‚öôÔ∏è Converter Dados</button>
            </div>
            
            <div id="tabelaProdutosAgrupada"></div>
        </div>
    </div>
    
    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD7pFuWi09QI8lnbtP6sTMBnGSzdoLqEi8",
            authDomain: "estoque-seu-vital.firebaseapp.com",
            databaseURL: "https://estoque-seu-vital-default-rtdb.firebaseio.com",
            projectId: "estoque-seu-vital",
            storageBucket: "estoque-seu-vital.firebasestorage.app",
            messagingSenderId: "367151266329",
            appId: "1:367151266329:web:f22ec128e36caffc624888",
            measurementId: "G-TXM7NCNPC3"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const produtosRef = database.ref('produtos');
        
        // Vari√°vel global de produtos
        let produtos = [];
        
        // Dados iniciais (usados apenas se Firebase estiver vazio)
        const produtosIniciais = [
            { id: 1, nome: 'Desinfetante Iguatemi', categoria: 'Desinfetantes', volume: '2L', qtd: 1620, preco: 5.50, lotes: [] },
            { id: 2, nome: 'Desinfetante Iguatemi', categoria: 'Desinfetantes', volume: '5L', qtd: 336, preco: 12.00, lotes: [] },
            { id: 3, nome: 'Desinfetante Stillo', categoria: 'Desinfetantes', volume: '2L', qtd: 1296, preco: 4.80, lotes: [] },
            { id: 4, nome: 'Desinfetante Stillo', categoria: 'Desinfetantes', volume: '5L', qtd: 252, preco: 10.50, lotes: [] },
            { id: 5, nome: 'Desinfetante Zix', categoria: 'Desinfetantes', volume: '2L', qtd: 1944, preco: 4.20, lotes: [] },
            { id: 6, nome: 'Desinfetante Zix', categoria: 'Desinfetantes', volume: '5L', qtd: 378, preco: 9.80, lotes: [] },
            { id: 7, nome: 'Desinfetante Lavanda Beb√™', categoria: 'Desinfetantes', volume: '2L', qtd: 1080, preco: 6.00, lotes: [] },
            { id: 8, nome: 'Desinfetante Lavanda Beb√™', categoria: 'Desinfetantes', volume: '5L', qtd: 210, preco: 13.50, lotes: [] },
            { id: 9, nome: 'Desinfetante Vinol', categoria: 'Desinfetantes', volume: '2L', qtd: 1512, preco: 5.20, lotes: [] },
            { id: 10, nome: 'Desinfetante Vinol', categoria: 'Desinfetantes', volume: '5L', qtd: 294, preco: 11.50, lotes: [] },
            { id: 11, nome: 'Desinfetante Natureza', categoria: 'Desinfetantes', volume: '2L', qtd: 1728, preco: 4.90, lotes: [] },
            { id: 12, nome: 'Desinfetante Natureza', categoria: 'Desinfetantes', volume: '5L', qtd: 336, preco: 10.80, lotes: [] },
            { id: 13, nome: 'Desinfetante Ervas Finas', categoria: 'Desinfetantes', volume: '2L', qtd: 1188, preco: 5.40, lotes: [] },
            { id: 14, nome: 'Desinfetante Ervas Finas', categoria: 'Desinfetantes', volume: '5L', qtd: 252, preco: 12.00, lotes: [] },
            { id: 15, nome: 'Desinfetante Floral', categoria: 'Desinfetantes', volume: '2L', qtd: 1404, preco: 5.10, lotes: [] },
            { id: 16, nome: 'Desinfetante Floral', categoria: 'Desinfetantes', volume: '5L', qtd: 294, preco: 11.20, lotes: [] },
            { id: 17, nome: 'Desinfetante Eucalipto', categoria: 'Desinfetantes', volume: '2L', qtd: 2052, preco: 4.70, lotes: [] },
            { id: 18, nome: 'Desinfetante Eucalipto', categoria: 'Desinfetantes', volume: '5L', qtd: 420, preco: 10.50, lotes: [] },
            
            // Amaciantes
            { id: 19, nome: 'Amaciante Pink', categoria: 'Amaciantes', volume: '2L', qtd: 2160, preco: 6.80, lotes: [] },
            { id: 20, nome: 'Amaciante Pink', categoria: 'Amaciantes', volume: '5L', qtd: 504, preco: 15.00, lotes: [] },
            { id: 21, nome: 'Amaciante Blue', categoria: 'Amaciantes', volume: '2L', qtd: 1944, preco: 6.50, lotes: [] },
            { id: 22, nome: 'Amaciante Blue', categoria: 'Amaciantes', volume: '5L', qtd: 420, preco: 14.50, lotes: [] },
            { id: 23, nome: 'Amaciante White', categoria: 'Amaciantes', volume: '2L', qtd: 2376, preco: 6.20, lotes: [] },
            { id: 24, nome: 'Amaciante White', categoria: 'Amaciantes', volume: '5L', qtd: 588, preco: 13.80, lotes: [] },
            
            // Lava Roupas
            { id: 25, nome: 'Lava Roupas Clear', categoria: 'Lava Roupas', volume: '2L', qtd: 2700, preco: 7.50, lotes: [] },
            { id: 26, nome: 'Lava Roupas Clear', categoria: 'Lava Roupas', volume: '5L', qtd: 630, preco: 16.50, lotes: [] },
            { id: 27, nome: 'Lava Roupas Tropical', categoria: 'Lava Roupas', volume: '2L', qtd: 2268, preco: 7.20, lotes: [] },
            { id: 28, nome: 'Lava Roupas Tropical', categoria: 'Lava Roupas', volume: '5L', qtd: 546, preco: 16.00, lotes: [] },
            { id: 29, nome: 'Lava Roupas Coco', categoria: 'Lava Roupas', volume: '2L', qtd: 2484, preco: 7.80, lotes: [] },
            { id: 30, nome: 'Lava Roupas Coco', categoria: 'Lava Roupas', volume: '5L', qtd: 588, preco: 17.00, lotes: [] },
            
            // Lava Lou√ßas
            { id: 31, nome: 'Lava Lou√ßas Neutro', categoria: 'Lava Lou√ßas', volume: '2L', qtd: 3024, preco: 5.80, lotes: [] },
            { id: 32, nome: 'Lava Lou√ßas Neutro', categoria: 'Lava Lou√ßas', volume: '5L', qtd: 672, preco: 12.50, lotes: [] },
            { id: 33, nome: 'Lava Lou√ßas Coco', categoria: 'Lava Lou√ßas', volume: '2L', qtd: 2808, preco: 6.10, lotes: [] },
            { id: 34, nome: 'Lava Lou√ßas Coco', categoria: 'Lava Lou√ßas', volume: '5L', qtd: 630, preco: 13.20, lotes: [] },
            { id: 35, nome: 'Lava Lou√ßas Lim√£o', categoria: 'Lava Lou√ßas', volume: '2L', qtd: 2592, preco: 5.90, lotes: [] },
            { id: 36, nome: 'Lava Lou√ßas Lim√£o', categoria: 'Lava Lou√ßas', volume: '5L', qtd: 588, preco: 12.80, lotes: [] },
            { id: 37, nome: 'Lava Lou√ßas Ma√ß√£', categoria: 'Lava Lou√ßas', volume: '2L', qtd: 2916, preco: 6.30, lotes: [] },
            { id: 38, nome: 'Lava Lou√ßas Ma√ß√£', categoria: 'Lava Lou√ßas', volume: '5L', qtd: 672, preco: 13.50, lotes: [] }
        ];
        
        // ===== FUN√á√ïES FIREBASE =====
        
        // Carregar produtos do Firebase
        function carregarProdutos() {
            produtosRef.once('value', (snapshot) => {
                const dados = snapshot.val();
                if (dados && Array.isArray(dados) && dados.length > 0) {
                    produtos = dados;
                    
                    // üîÑ CONVERS√ÉO AUTOM√ÅTICA de andares para unidades reais
                    const convertidos = converterParaUnidadesReais(produtos);
                    
                    if (convertidos > 0) {
                        console.log(`‚úÖ ${convertidos} produtos convertidos automaticamente!`);
                        salvarDados(); // Salvar os dados convertidos
                    }
                    
                    console.log('‚úÖ Produtos carregados do Firebase:', produtos.length);
                } else {
                    // Se Firebase vazio, usar dados iniciais
                    produtos = produtosIniciais;
                    // Marcar todos como vers√£o 2
                    produtos.forEach(p => p._v = 2);
                    salvarDados(); // Salvar dados iniciais no Firebase
                    console.log('üì¶ Dados iniciais carregados e salvos no Firebase');
                }
                renderizarTabela();
                inicializarGrafico();
            });
        }
        
        // Fun√ß√£o para converter produtos de andares para unidades reais
        function converterParaUnidadesReais(listaProdutos) {
            let convertidos = 0;
            listaProdutos.forEach(p => {
                // Se j√° tem marcador de vers√£o 2, n√£o converter
                if (p._v === 2) return;
                
                const unidades = obterUnidades(p);
                const qtdAtual = parseInt(p.qtd, 10) || 0;
                const limiteDeteccao = p.volume === '5L' ? 50 : 100;
                
                // Se qtd √© pequeno, provavelmente √© andar (formato antigo)
                if (qtdAtual < limiteDeteccao && qtdAtual > 0) {
                    p.qtd = qtdAtual * unidades;
                    p._v = 2; // Marca como vers√£o 2 (unidades reais)
                    console.log(`üîÑ Convertido: ${p.nome} (${p.volume}) ‚Üí ${p.qtd} unidades`);
                    convertidos++;
                } else if (qtdAtual >= limiteDeteccao) {
                    // J√° est√° em unidades, s√≥ marca
                    p._v = 2;
                }
            });
            return convertidos;
        }
        
        // Listener em tempo real - atualiza quando algu√©m modificar
        let primeiraExecucao = true;
        produtosRef.on('value', (snapshot) => {
            const dados = snapshot.val();
            if (dados && Array.isArray(dados)) {
                // Pular primeira execu√ß√£o (j√° tratada em carregarProdutos)
                if (primeiraExecucao) {
                    primeiraExecucao = false;
                    return;
                }
                
                produtos = dados;
                renderizarTabela();
                console.log('üîÑ Dados atualizados em tempo real!');
            }
        });
        
        // Converter dados antigos de andares para unidades reais
        function converterDadosAntigos() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta fun√ß√£o vai converter os dados do Firebase de andares para unidades reais.\n\nVoc√™ PRECISA fazer isso UMA VEZ para corrigir os c√°lculos!\n\nExemplo: se mostra 324 unidades (3 andares), continuar√° mostrando 324.\n\nConfirma convers√£o?')) {
                let convertidos = 0;
                let jaConvertido = false;
                
                produtos.forEach(p => {
                    const unidades = obterUnidades(p);
                    const qtdAtual = parseInt(p.qtd, 10) || 0;
                    
                    // Detecta se √© andar (valores pequenos) ou unidades reais (valores grandes)
                    // Para 2L: andares s√£o < 50, unidades reais s√£o > 100
                    // Para 5L: andares s√£o < 30, unidades reais s√£o > 50
                    const limiteDeteccao = p.volume === '5L' ? 50 : 100;
                    
                    if (qtdAtual < limiteDeteccao) {
                        const qtdAntiga = qtdAtual;
                        p.qtd = qtdAtual * unidades;
                        console.log(`üîÑ ${p.nome} (${p.volume}): ${qtdAntiga} andares ‚Üí ${p.qtd} unidades`);
                        convertidos++;
                    } else {
                        jaConvertido = true;
                    }
                });
                
                salvarDados();
                
                if (convertidos > 0) {
                    alert(`‚úÖ Convers√£o conclu√≠da!\n\n${convertidos} produtos convertidos para unidades reais.\n\nAgora os c√°lculos funcionar√£o corretamente!`);
                } else if (jaConvertido) {
                    alert(`‚ö†Ô∏è Os dados j√° parecem estar convertidos!\n\nSe ainda houver problemas, clique em "Resetar Dados" para recome√ßar.`);
                } else {
                    alert('Nenhum produto precisou ser convertido.');
                }
            }
        }
        
        function obterUnidades(produto) {
            return produto.volume === '5L' ? 42 : 108;
        }
        
        function salvarDados() {
            produtosRef.set(produtos)
                .then(() => {
                    console.log('‚úÖ Dados salvos no Firebase (sincronizado em tempo real)');
                })
                .catch((error) => {
                    console.error('‚ùå Erro ao salvar no Firebase:', error);
                    alert('Erro ao salvar dados. Verifique sua conex√£o com a internet.');
                });
        }
        
        function atualizarEstatisticas() {
            const totalUnidades = produtos.reduce((sum, p) => sum + (p.qtd * obterUnidades(p)), 0);
            const valorTotal = produtos.reduce((sum, p) => sum + (p.qtd * p.preco), 0);
            const estoqueCritico = produtos.filter(p => {
                const unidadesTotal = p.qtd * obterUnidades(p);
                // Para 2L: alerta com 108 unidades (1 andar). Para 5L: alerta com 42 unidades (1 andar)
                const limite = p.volume === '5L' ? 42 : 108;
                return unidadesTotal <= limite;
            }).length;
            
            document.getElementById('totalProdutos').textContent = totalUnidades;
            document.getElementById('valorTotal').textContent = 'R$ ' + valorTotal.toFixed(2);
            document.getElementById('baixoEstoque').textContent = estoqueCritico;
        }
        
        function renderizarTabela(filtro = '') {
            const container = document.getElementById('tabelaProdutosAgrupada');
            const filterCategoria = document.getElementById('filterCategoria').value;
            const filterVolume = document.getElementById('filterVolume').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // Filtrar produtos
            let produtosFiltrados = produtos.filter(p => {
                const matchBusca = p.nome.toLowerCase().includes(searchTerm);
                const matchCategoria = filterCategoria === '' || p.categoria === filterCategoria;
                const matchVolume = filterVolume === '' || p.volume === filterVolume;
                return matchBusca && matchCategoria && matchVolume;
            });
            
            // Agrupar por categoria
            const gruposPorCategoria = {};
            produtosFiltrados.forEach(p => {
                if (!gruposPorCategoria[p.categoria]) {
                    gruposPorCategoria[p.categoria] = {};
                }
                if (!gruposPorCategoria[p.categoria][p.volume]) {
                    gruposPorCategoria[p.categoria][p.volume] = [];
                }
                gruposPorCategoria[p.categoria][p.volume].push(p);
            });
            
            // Renderizar categorias
            container.innerHTML = '';
            Object.keys(gruposPorCategoria).sort().forEach(categoria => {
                const divCategoria = document.createElement('div');
                divCategoria.className = 'category-group';
                
                let htmlCategoria = `<div class="category-title">üìÅ ${categoria}</div>`;
                
                // Renderizar volumes dentro da categoria
                Object.keys(gruposPorCategoria[categoria]).sort().forEach(volume => {
                    const produtos_volume = gruposPorCategoria[categoria][volume];
                    htmlCategoria += `<div class="volume-subgroup"><div class="volume-label">Volume: ${volume}</div>`;
                    
                    htmlCategoria += `<table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                        <thead>
                            <tr style="background: #ecf0f1;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #bdc3c7;">Produto</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #bdc3c7;">Quantidade</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #bdc3c7;">Pre√ßo Unit.</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #bdc3c7;">Total</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #bdc3c7;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    produtos_volume.forEach(p => {
                        const qtdUnidades = parseInt(p.qtd, 10) || 0;
                        const unidades = obterUnidades(p);
                        const andares = Math.ceil(qtdUnidades / unidades);
                        const total = (andares * p.preco).toFixed(2);
                        const lowStock = qtdUnidades <= (p.volume === '5L' ? 42 : 108);
                        const lowStockStyle = lowStock ? 'background: #fadbd8;' : '';
                        
                        // Renderizar linha da tabela (desktop)
                        htmlCategoria += `
                            <tr style="${lowStockStyle}">
                                <td style="padding: 12px; border-bottom: 1px solid #ecf0f1;">${p.nome}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #ecf0f1;">${qtdUnidades} un</td>
                                <td style="padding: 12px; border-bottom: 1px solid #ecf0f1;">R$ ${p.preco.toFixed(2)}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #ecf0f1;">R$ ${total}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #ecf0f1;">
                                    <button class="btn-small" onclick="entradaMercadoria(${p.id})" style="background:#27ae60">Entrada</button>
                                    <button class="btn-small" onclick="saidaMercadoria(${p.id})" style="background:#e74c3c">Sa√≠da</button>
                                    <button class="btn-small" onclick="visualizarHistorico(${p.id})" style="background:#9b59b6">Hist√≥rico</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    htmlCategoria += `</tbody></table>`;
                    
                    // Renderizar cards (mobile)
                    produtos_volume.forEach(p => {
                        const qtdUnidades = parseInt(p.qtd, 10) || 0;
                        const unidades = obterUnidades(p);
                        const andares = Math.ceil(qtdUnidades / unidades);
                        const total = (andares * p.preco).toFixed(2);
                        const lowStock = qtdUnidades <= (p.volume === '5L' ? 42 : 108);
                        const alertIcon = lowStock ? ' ‚ö†Ô∏è' : '';
                        
                        htmlCategoria += `
                            <div class="mobile-card" style="${lowStock ? 'border-left: 4px solid #e74c3c;' : ''}">
                                <div class="mobile-card-header">${p.nome}${alertIcon}</div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Volume:</span>
                                    <span class="mobile-card-value">${p.volume}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Quantidade:</span>
                                    <span class="mobile-card-value">${qtdUnidades} un</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Pre√ßo Unit.:</span>
                                    <span class="mobile-card-value">R$ ${p.preco.toFixed(2)}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Total:</span>
                                    <span class="mobile-card-value">R$ ${total}</span>
                                </div>
                                <div class="mobile-card-actions">
                                    <button onclick="entradaMercadoria(${p.id})" style="background:#27ae60; color:white; border:none; border-radius:8px; padding:12px; font-weight:600;">+ Entrada</button>
                                    <button onclick="saidaMercadoria(${p.id})" style="background:#e74c3c; color:white; border:none; border-radius:8px; padding:12px; font-weight:600;">- Sa√≠da</button>
                                    <button onclick="visualizarHistorico(${p.id})" style="background:#9b59b6; color:white; border:none; border-radius:8px; padding:12px; font-weight:600;">üìã</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    htmlCategoria += `</div>`;
                });
                
                divCategoria.innerHTML = htmlCategoria;
                container.appendChild(divCategoria);
            });
            
            // Preencher filtro de categorias
            const categorias = [...new Set(produtos.map(p => p.categoria))].sort();
            const selectCategoria = document.getElementById('filterCategoria');
            const categoriaAtual = selectCategoria.value;
            selectCategoria.innerHTML = '<option value="">Todas as Categorias</option>';
            categorias.forEach(cat => {
                selectCategoria.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            selectCategoria.value = categoriaAtual;
            
            atualizarEstatisticas();
        }
        
        function adicionarProduto() {
            const nome = prompt('Nome do produto:');
            if (!nome) return;
            const qtd = parseInt(prompt('Quantidade:')) || 0;
            const preco = parseFloat(prompt('Pre√ßo unit√°rio:')) || 0;
            
            produtos.push({
                id: Date.now(),
                nome,
                categoria: 'Outros',
                volume: '2L',
                qtd,
                preco,
                lotes: []
            });
            salvarDados();
            renderizarTabela();
        }
        
        function deletarProduto(id) {
            if (confirm('Confirmar exclus√£o?')) {
                produtos = produtos.filter(p => p.id !== id);
                salvarDados();
                renderizarTabela();
            }
        }
        
        function editarProduto(id) {
            const p = produtos.find(x => x.id === id);
            if (!p) return;
            const novaQtd = parseInt(prompt('Nova quantidade:', p.qtd));
            if (novaQtd !== null && novaQtd >= 0) {
                p.qtd = novaQtd;
                salvarDados();
                renderizarTabela();
            }
        }
        
        function entradaMercadoria(id) {
            const p = produtos.find(x => x.id === id);
            if (!p) return;
            
            console.log('=== ENTRADA DEBUG ===');
            console.log('Produto:', p.nome, p.volume);
            console.log('Qtd ANTES (tipo):', typeof p.qtd, 'valor:', p.qtd);
            
            const lote = prompt('N√∫mero do lote:');
            if (!lote) return;
            const qtdInput = prompt('Quantidade de unidades:');
            const qtd = parseInt(qtdInput, 10);
            if (isNaN(qtd) || qtd <= 0) {
                alert('Quantidade inv√°lida!');
                return;
            }
            
            console.log('Unidades a adicionar:', qtd);
            
            const qtdAnterior = parseInt(p.qtd, 10) || 0;
            p.qtd = qtdAnterior + qtd;
            p._v = 2; // Marca como vers√£o 2
            
            console.log('C√°lculo: ', qtdAnterior, '+', qtd, '=', p.qtd);
            console.log('Qtd DEPOIS (tipo):', typeof p.qtd, 'valor:', p.qtd);
            console.log('===================');
            
            if (!p.lotes) p.lotes = [];
            p.lotes.push({ numero: lote, data: new Date().toLocaleDateString(), tipo: 'entrada', qtd });
            salvarDados();
            renderizarTabela();
        }
        
        function saidaMercadoria(id) {
            const p = produtos.find(x => x.id === id);
            if (!p) return;
            
            console.log('=== SA√çDA DEBUG ===');
            console.log('Produto:', p.nome, p.volume);
            console.log('Qtd ANTES (tipo):', typeof p.qtd, 'valor:', p.qtd);
            
            const qtdInput = prompt('Quantidade de unidades a retirar:');
            const qtd = parseInt(qtdInput, 10);
            if (isNaN(qtd) || qtd <= 0) {
                alert('Quantidade inv√°lida!');
                return;
            }
            
            console.log('Unidades a retirar:', qtd);
            
            const qtdAtual = parseInt(p.qtd, 10) || 0;
            
            console.log('Qtd dispon√≠vel:', qtdAtual);
            
            if (qtd <= qtdAtual) {
                const qtdAnterior = qtdAtual;
                p.qtd = Math.max(0, qtdAnterior - qtd);
                p._v = 2; // Marca como vers√£o 2
                
                console.log('C√°lculo: ', qtdAnterior, '-', qtd, '=', p.qtd);
                console.log('Qtd DEPOIS (tipo):', typeof p.qtd, 'valor:', p.qtd);
                console.log('===================');
                
                if (!p.lotes) p.lotes = [];
                p.lotes.push({ numero: 'N/A', data: new Date().toLocaleDateString(), tipo: 'saida', qtd });
                salvarDados();
                renderizarTabela();
            } else {
                alert(`Quantidade inv√°lida! Dispon√≠vel: ${qtdAtual} un`);
            }
        }
        
        function visualizarHistorico(id) {
            const p = produtos.find(x => x.id === id);
            if (!p || !p.lotes || p.lotes.length === 0) {
                alert('Nenhum movimento registrado para este produto.');
                return;
            }
            
            let historico = `Hist√≥rico: ${p.nome} (${p.volume})\n\n`;
            p.lotes.forEach(l => {
                historico += `${l.data} - ${l.tipo.toUpperCase()}: ${l.qtd} un (Lote: ${l.numero})\n`;
            });
            alert(historico);
        }
        
        function limparDados() {
            if (confirm('ATEN√á√ÉO: Isso vai apagar TODOS os dados do Firebase e voltar aos dados iniciais. Todos os usu√°rios ser√£o afetados. Confirma?')) {
                produtos = produtosIniciais;
                salvarDados();
                alert('Dados resetados com sucesso!');
            }
        }
        
        function exportarExcel() {
            const dados = produtos.map(p => {
                const qtdUnidades = parseInt(p.qtd, 10) || 0;
                const unidades = obterUnidades(p);
                const andares = Math.ceil(qtdUnidades / unidades);
                return {
                    'Produto': p.nome,
                    'Volume': p.volume,
                    'Categoria': p.categoria,
                    'Quantidade': qtdUnidades,
                    'Andares': andares,
                    'Pre√ßo Unit.': p.preco.toFixed(2),
                    'Total': (andares * p.preco).toFixed(2)
                };
            });
            
            // Gerar CSV (compat√≠vel com Excel)
            let csv = 'Produto,Volume,Categoria,Quantidade,Unidades Reais,Pre√ßo Unit.,Total\n';
            dados.forEach(d => {
                csv += `"${d.Produto}","${d.Volume}","${d.Categoria}",${d.Quantidade},${d['Unidades Reais']},${d['Pre√ßo Unit.']},${d.Total}\n`;
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Estoque_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
            link.click();
        }
        
        function exportarPDF() {
            if (!window.jspdf) {
                alert('PDF n√£o dispon√≠vel offline. Conecte-se √† internet para exportar em PDF.');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Galpao Seu Vital - Controle de Estoque', 14, 15);
            
            doc.setFontSize(10);
            doc.text(`Data: ${new Date().toLocaleDateString()}`, 14, 25);
            
            const dados = produtos.map(p => [
                p.nome,
                p.volume,
                p.categoria,
                p.qtd,
                p.qtd * obterUnidades(p),
                'R$ ' + p.preco.toFixed(2),
                'R$ ' + (p.qtd * p.preco).toFixed(2)
            ]);
            
            doc.autoTable({
                head: [['Produto', 'Volume', 'Categoria', 'Qtd', 'Un. Reais', 'Pre√ßo Unit.', 'Total']],
                body: dados,
                startY: 35,
                styles: {
                    fontSize: 9,
                    cellPadding: 5
                },
                headStyles: {
                    fillColor: [44, 62, 80],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                }
            });
            
            const totalProdutos = produtos.reduce((sum, p) => sum + p.qtd, 0);
            const valorTotal = produtos.reduce((sum, p) => sum + (p.qtd * p.preco), 0);
            const finalY = doc.lastAutoTable.finalY + 10;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`Total de Produtos: ${totalProdutos}`, 14, finalY);
            doc.text(`Valor Total em Estoque: R$ ${valorTotal.toFixed(2)}`, 14, finalY + 7);
            
            doc.save(`Estoque_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`);
        }
        
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            renderizarTabela();
        });

        // Disable/enable PDF export button based on availability
        function updateExportButtons() {
            const btnPdf = document.querySelector('.btn-export.pdf');
            if (!btnPdf) return;
            if (navigator.onLine && window.jspdf) {
                btnPdf.disabled = false;
                btnPdf.style.opacity = 1;
                btnPdf.title = '';
            } else {
                btnPdf.disabled = true;
                btnPdf.style.opacity = 0.6;
                btnPdf.title = 'PDF export requires internet connection and jsPDF';
            }
        }

        window.addEventListener('online', updateExportButtons);
        window.addEventListener('offline', updateExportButtons);
        // Check availability periodically (in case scripts get cached)
        setTimeout(updateExportButtons, 500);
        
        // ===== GR√ÅFICOS =====
        let chartInstance = null;
        let currentPeriod = 7;
        
        function calcularMovimentacaoPeriodo(dias) {
            const dataInicio = new Date();
            dataInicio.setDate(dataInicio.getDate() - dias);
            
            const entradas = {};
            const saidas = {};
            
            // Inicializar todos os dias do per√≠odo
            for (let i = 0; i < dias; i++) {
                const data = new Date();
                data.setDate(data.getDate() - (dias - 1 - i));
                const dataStr = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                entradas[dataStr] = 0;
                saidas[dataStr] = 0;
            }
            
            // Contabilizar movimenta√ß√µes
            produtos.forEach(p => {
                if (!p.lotes || p.lotes.length === 0) return;
                p.lotes.forEach(lote => {
                    const partesData = lote.data.split('/');
                    const dataLote = new Date(partesData[2], partesData[1] - 1, partesData[0]);
                    
                    if (dataLote >= dataInicio) {
                        const dataStr = dataLote.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                        if (lote.tipo === 'entrada') {
                            if (entradas[dataStr] !== undefined) entradas[dataStr] += lote.qtd;
                        } else if (lote.tipo === 'saida') {
                            if (saidas[dataStr] !== undefined) saidas[dataStr] += lote.qtd;
                        }
                    }
                });
            });
            
            return { entradas, saidas };
        }
        
        function atualizarGrafico(dias) {
            currentPeriod = dias;
            
            // Atualizar tabs
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const { entradas, saidas } = calcularMovimentacaoPeriodo(dias);
            const labels = Object.keys(entradas);
            const dataEntradas = Object.values(entradas);
            const dataSaidas = Object.values(saidas);
            
            const ctx = document.getElementById('movimentacaoChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entradas',
                            data: dataEntradas,
                            borderColor: 'rgb(52, 211, 153)',
                            backgroundColor: 'rgba(52, 211, 153, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Sa√≠das',
                            data: dataSaidas,
                            borderColor: 'rgb(251, 113, 133)',
                            backgroundColor: 'rgba(251, 113, 133, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Movimenta√ß√£o dos √∫ltimos ${dias} dias`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    }
                }
            });
        }
        
        // Fun√ß√£o para inicializar gr√°fico (chamada ap√≥s carregar dados)
        function inicializarGrafico() {
            setTimeout(() => {
                if (window.Chart) {
                    atualizarGrafico(7);
                }
            }, 500);
        }
        
        // ===== INICIALIZA√á√ÉO =====
        // Carregar produtos do Firebase ao iniciar
        carregarProdutos();
        
        // Listener de busca
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            renderizarTabela();
        });
        
        // Registrar Service Worker para PWA (somente em http/https ou localhost)
        if ('serviceWorker' in navigator) {
            const allowed = (location.protocol === 'http:' || location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
            if (!allowed) {
                console.warn('Service Worker n√£o ser√° registrado: p√°gina aberta via file:// (origem null). Sirva o arquivo via http/https (ex: python -m http.server) para habilitar o PWA.');
                // opcional: mostrar dica ao usu√°rio
                if (!document.getElementById('pwaHint')) {
                    const hint = document.createElement('div');
                    hint.id = 'pwaHint';
                    hint.style.position = 'fixed';
                    hint.style.right = '12px';
                    hint.style.bottom = '12px';
                    hint.style.padding = '10px 14px';
                    hint.style.background = '#f39c12';
                    hint.style.color = '#fff';
                    hint.style.borderRadius = '6px';
                    hint.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                    hint.textContent = 'PWA desativado: abra via http://localhost:8000 para habilitar offline/instala√ß√£o.';
                    document.body.appendChild(hint);
                }
            } else {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado:', registration);
                    })
                    .catch(error => {
                        console.log('Erro ao registrar Service Worker:', error);
                        // mostrar mensagem curta ao usu√°rio
                        console.error('Service Worker registration failed:', error);
                    });
            }
        }
        
        // Detectar quando o app est√° pronto para ser instalado
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('App est√° pronto para ser instalado');
        });
        
        // Mostrar mensagem quando instalado
        window.addEventListener('appinstalled', () => {
            console.log('Aplicativo instalado com sucesso!');
            alert('App instalado com sucesso! Voc√™ pode agora usar offline.');
        });
    </script>
</body>
</html>